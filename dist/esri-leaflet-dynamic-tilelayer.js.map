{"version":3,"file":"esri-leaflet-dynamic-tilelayer.js","sources":["../src/Layers/DynamicMapLayer/TiledDynamicMapLayer.js"],"names":["EsriLeaflet","Layers","TiledDynamicMapLayer","L","TileLayer","extend","options","Util","DynamicMapLayer","prototype","_requests","initialize","url","call","this","onAdd","map","crs","code","sr","split","bboxSR","imageSR","on","_onZoom","onRemove","off","setLayers","layers","_reset","setLayerDefs","layerDefs","setTimeOptions","timeOptions","e","_zooming","type","_buildExportParams","bounds","size","ne","_map","project","_northEast","sw","_southWest","top","latLngToLayerPoint","bottom","y","params","bbox","x","join","dpi","format","transparent","JSON","stringify","from","to","time","valueOf","_service","token","_loadTile","tile","tilePoint","_layer","onload","_tileOnLoad","onerror","_tileOnError","_adjustTilePoint","getTileUrl","err","src","fire","callback","tileSize","nwPoint","multiplyBy","sePoint","add","LatLngBounds","unproject","z","Point","_requestExport","f","push","get","error","response","href","_renderImage","getParamString","_update","_animatingZoom","methods","i","len","length","tiledDynamicMapLayer"],"mappings":"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","sourcesContent":["EsriLeaflet.Layers.TiledDynamicMapLayer = L.TileLayer.extend({\n\n  options: L.Util.extend({}, EsriLeaflet.Layers.DynamicMapLayer.prototype.options),\n\n  _requests: [],\n\n  initialize: function(url, options) {\n    L.TileLayer.prototype.initialize.call(this, url, options);\n    EsriLeaflet.DynamicMapLayer.prototype.initialize.call(this, url, options);\n  },\n\n  onAdd: function(map) {\n    if (map.options.crs && map.options.crs.code) {\n      var sr = map.options.crs.code.split(':')[1];\n      this.options.bboxSR = sr;\n      this.options.imageSR = sr;\n    }\n\n    map.on('zoomstart zoomend', this._onZoom, this);\n    return L.TileLayer.prototype.onAdd.call(this, map);\n  },\n\n  onRemove: function(map) {\n    map.off('zoomstart zoomend', this._onZoom, this);\n    L.TileLayer.prototype.onRemove.call(this, map);\n    EsriLeaflet.DynamicMapLayer.prototype.onRemove.call(this, map);\n  },\n\n  setLayers: function(layers) {\n    this._reset();\n    EsriLeaflet.Layers.DynamicMapLayer.prototype.setLayers.call(this, layers);\n  },\n\n  setLayerDefs: function(layerDefs) {\n    this._reset();\n    EsriLeaflet.Layers.DynamicMapLayer.prototype.setLayerDefs.call(this, layerDefs);\n  },\n\n  setTimeOptions: function(timeOptions) {\n    this._reset();\n    EsriLeaflet.Layers.DynamicMapLayer.prototype.setTimeOptions.call(this, timeOptions);\n  },\n\n  _onZoom: function(e) {\n    this._zooming = (e.type === 'zoomstart');\n  },\n\n  _buildExportParams: function(bounds, size) {\n    var ne = this._map.options.crs.project(bounds._northEast);\n    var sw = this._map.options.crs.project(bounds._southWest);\n\n    //ensure that we don't ask ArcGIS Server for a taller image than we have actual map displaying\n    var top = this._map.latLngToLayerPoint(bounds._northEast);\n    var bottom = this._map.latLngToLayerPoint(bounds._southWest);\n\n    if (top.y > 0 || bottom.y < size.y) {\n      size.y = bottom.y - top.y;\n    }\n\n    var params = {\n      bbox: [sw.x, sw.y, ne.x, ne.y].join(','),\n      size: size.x + ',' + size.y,\n      dpi: 96,\n      format: this.options.format,\n      transparent: this.options.transparent,\n      bboxSR: this.options.bboxSR,\n      imageSR: this.options.imageSR\n    };\n\n    if (this.options.layers) {\n      params.layers = 'show:' + this.options.layers.join(',');\n    }\n\n    if (this.options.layerDefs) {\n      params.layerDefs = JSON.stringify(this.options.layerDefs);\n    }\n\n    if (this.options.timeOptions) {\n      params.timeOptions = JSON.stringify(this.options.timeOptions);\n    }\n\n    if (this.options.from && this.options.to) {\n      params.time = this.options.from.valueOf() + ',' + this.options.to.valueOf();\n    }\n\n    if (this._service.options.token) {\n      params.token = this._service.options.token;\n    }\n\n    return params;\n  },\n\n  _loadTile: function(tile, tilePoint) {\n    tile._layer = this;\n    tile.onload = this._tileOnLoad;\n    tile.onerror = this._tileOnError;\n\n    this._adjustTilePoint(tilePoint);\n    this.getTileUrl(tilePoint, function(err, url) {\n      tile.src = url;\n    });\n\n    this.fire('tileloadstart', {\n      tile: tile\n    });\n  },\n\n  getTileUrl: function(tilePoint, callback) { // (Point, Number) -> String\n\n    var map = this._map,\n      tileSize = this.options.tileSize,\n\n      nwPoint = tilePoint.multiplyBy(tileSize),\n      sePoint = nwPoint.add([tileSize, tileSize]);\n\n    var bounds = new L.LatLngBounds(map.unproject(nwPoint, tilePoint.z),\n      map.unproject(sePoint, tilePoint.z));\n    var size = new L.Point(this.options.tileSize, this.options.tileSize);\n\n    var params = this._buildExportParams(bounds, size);\n    this._requestExport(params, bounds, callback);\n  },\n\n  _requestExport: function(params, bounds, callback) {\n    if (this.options.f === 'json') {\n      this._requests.push(this._service.get('export', params, function(error, response) {\n        callback(null, response.href, bounds);\n      }, this));\n    } else {\n      params.f = 'image';\n      this._renderImage(this.options.url + 'export' + L.Util.getParamString(params), bounds);\n    }\n  },\n\n  _update: function() {\n    if (this._map && this._map._animatingZoom) {\n      return;\n    }\n    L.TileLayer.prototype._update.call(this);\n  },\n\n});\n\n(function(methods) {\n  for (var i = 0, len = methods.length; i < len; i++) {\n    EsriLeaflet.Layers.TiledDynamicMapLayer.prototype[methods[i]] =\n      EsriLeaflet.Layers.DynamicMapLayer.prototype[methods[i]];\n  }\n})([\n  'getLayers',\n  'getLayerDefs',\n  'getTimeOptions',\n  'setTimeOptions',\n  'metadata',\n  'query',\n  'identify',\n  'find',\n  '_getPopupData',\n  '_propagateEvent'\n]);\n\nEsriLeaflet.tiledDynamicMapLayer = function(url, options) {\n  return new EsriLeaflet.Layers.TiledDynamicMapLayer(url, options);\n};\n"]}