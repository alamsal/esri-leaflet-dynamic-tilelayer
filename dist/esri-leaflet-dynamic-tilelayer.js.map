{"version":3,"file":"esri-leaflet-dynamic-tilelayer.js","sources":["../src/Layers/DynamicMapLayer/TiledDynamicMapLayer.js"],"names":["EsriLeaflet","Layers","TiledDynamicMapLayer","L","TileLayer","extend","options","Util","DynamicMapLayer","prototype","redrawBuffer","_requests","initialize","url","call","this","onAdd","map","crs","code","sr","_getSr","bboxSR","imageSR","on","_onZoomChange","split","onRemove","off","setLayers","layers","_redraw","setLayerDefs","layerDefs","setTimeOptions","timeOptions","e","_zooming","type","_buildExportParams","bounds","size","ne","_map","project","_northEast","sw","_southWest","top","latLngToLayerPoint","bottom","y","params","bbox","x","join","dpi","format","transparent","JSON","stringify","from","to","time","valueOf","_service","token","_loadTile","tile","tilePoint","_layer","onload","_tileOnLoad","onerror","_tileOnError","_adjustTilePoint","getTileUrl","err","src","fire","callback","tileSize","nwPoint","multiplyBy","sePoint","add","LatLngBounds","unproject","z","Point","_requestExport","f","push","get","error","response","href","getParamString","front","_tileContainer","_clearBgBuffer","_bgBuffer","_tiles","_tilesToLoad","_tilesTotal","_reset","hard","_initContainer","_animated","_update","_animatingZoom","methods","i","len","length","tiledDynamicMapLayer"],"mappings":"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","sourcesContent":["EsriLeaflet.Layers.TiledDynamicMapLayer = L.TileLayer.extend({\n\n  options: L.Util.extend({},\n    EsriLeaflet.Layers.DynamicMapLayer.prototype.options, {\n      redrawBuffer: true\n    }),\n\n  /**\n   * @type {Array.<XmlHttpRequest>}\n   */\n  _requests: [],\n\n  /**\n   * @constructor\n   * @extends {L.TileLayer}\n   * @param  {String} url\n   * @param  {Object} options\n   */\n  initialize: function(url, options) {\n    L.TileLayer.prototype.initialize.call(this, url, options);\n    EsriLeaflet.DynamicMapLayer.prototype.initialize.call(this, url, options);\n  },\n\n  /**\n   * @param  {L.Map} map\n   */\n  onAdd: function(map) {\n    if (map.options.crs && map.options.crs.code) {\n      var sr = this._getSr(map.options.crs.code);\n      this.options.bboxSR = sr;\n      this.options.imageSR = sr;\n    }\n\n    map.on('zoomstart zoomend', this._onZoomChange, this);\n    return L.TileLayer.prototype.onAdd.call(this, map);\n  },\n\n  /**\n   * Could be WKT and at least possble to override\n   * @param  {String} code\n   * @return {String}\n   */\n  _getSr: function(code) {\n    return code.split(':')[1];\n  },\n\n  /**\n   * @param  {L.Map} map\n   */\n  onRemove: function(map) {\n    map.off('zoomstart zoomend', this._onZoomChange, this);\n    L.TileLayer.prototype.onRemove.call(this, map);\n    EsriLeaflet.DynamicMapLayer.prototype.onRemove.call(this, map);\n  },\n\n  /**\n   * @param {Array.<Number>|Array.<String>} layers\n   * @return {L.esri.Layers.TiledDynamicMapLayer} self\n   */\n  setLayers: function(layers) {\n    this._redraw();\n    return EsriLeaflet.Layers.DynamicMapLayer.prototype.setLayers.call(this, layers);\n  },\n\n  /**\n   * @param {Array.<Object>} layerDefs\n   * @return {L.esri.Layers.TiledDynamicMapLayer} self\n   */\n  setLayerDefs: function(layerDefs) {\n    this._redraw();\n    return EsriLeaflet.Layers.DynamicMapLayer.prototype.setLayerDefs.call(this, layerDefs);\n  },\n\n  /**\n   * @param {Object} timeOptions\n   * @return {L.esri.Layers.TiledDynamicMapLayer} self\n   */\n  setTimeOptions: function(timeOptions) {\n    this._redraw();\n    return EsriLeaflet.Layers.DynamicMapLayer.prototype.setTimeOptions.call(this, timeOptions);\n  },\n\n  /**\n   * Set/unset zooming flag to avoid unneeded requests\n   * @param  {Object} e\n   */\n  _onZoomChange: function(e) {\n    this._zooming = (e.type === 'zoomstart');\n  },\n\n  /**\n   * @param  {L.LatLngBounds} bounds\n   * @param  {L.Point}        size\n   * @return {Object}\n   */\n  _buildExportParams: function(bounds, size) {\n    var ne = this._map.options.crs.project(bounds._northEast);\n    var sw = this._map.options.crs.project(bounds._southWest);\n\n    //ensure that we don't ask ArcGIS Server for a taller image than we have actual map displaying\n    var top = this._map.latLngToLayerPoint(bounds._northEast);\n    var bottom = this._map.latLngToLayerPoint(bounds._southWest);\n\n    if (top.y > 0 || bottom.y < size.y) {\n      size.y = bottom.y - top.y;\n    }\n\n    var params = {\n      bbox: [sw.x, sw.y, ne.x, ne.y].join(','),\n      size: size.x + ',' + size.y,\n      dpi: 96,\n      format: this.options.format,\n      transparent: this.options.transparent,\n      bboxSR: this.options.bboxSR,\n      imageSR: this.options.imageSR\n    };\n\n    if (this.options.layers) {\n      params.layers = 'show:' + this.options.layers.join(',');\n    }\n\n    if (this.options.layerDefs) {\n      params.layerDefs = JSON.stringify(this.options.layerDefs);\n    }\n\n    if (this.options.timeOptions) {\n      params.timeOptions = JSON.stringify(this.options.timeOptions);\n    }\n\n    if (this.options.from && this.options.to) {\n      params.time = this.options.from.valueOf() + ',' + this.options.to.valueOf();\n    }\n\n    if (this._service.options.token) {\n      params.token = this._service.options.token;\n    }\n\n    return params;\n  },\n\n  /**\n   * @param  {Object}  tile\n   * @param  {L.Point} tilePoint\n   */\n  _loadTile: function(tile, tilePoint) {\n    tile._layer = this;\n    tile.onload = this._tileOnLoad;\n    tile.onerror = this._tileOnError;\n\n    this._adjustTilePoint(tilePoint);\n    this.getTileUrl(tilePoint, function(err, url) {\n      if (err) {\n        this._tileOnError.call(tile);\n      } else {\n        tile.src = url;\n      }\n    }, tile);\n\n    this.fire('tileloadstart', {\n      tile: tile\n    });\n  },\n\n  /**\n   * Async request tile url\n   * @param  {L.Point}  tilePoint\n   * @param  {Function} callback\n   * @param  {Image}    tile\n   */\n  getTileUrl: function(tilePoint, callback) {\n    var map = this._map,\n      tileSize = this.options.tileSize,\n\n      nwPoint = tilePoint.multiplyBy(tileSize),\n      sePoint = nwPoint.add([tileSize, tileSize]);\n\n    var bounds = new L.LatLngBounds(\n      map.unproject(nwPoint, tilePoint.z),\n      map.unproject(sePoint, tilePoint.z)\n    );\n    var size = new L.Point(this.options.tileSize, this.options.tileSize);\n\n    var params = this._buildExportParams(bounds, size);\n    this._requestExport(params, bounds, callback);\n  },\n\n  /**\n   * Export call, json or image straight awy\n   * @param  {Object}          params\n   * @param  {L.LatLngBounds}  bounds\n   * @param  {Function}        callback\n   */\n  _requestExport: function(params, bounds, callback) {\n    if (this.options.f === 'json') {\n      this._requests.push(this._service.get('export', params, function(error, response) {\n        if (error) {\n          callback(error, response);\n        } else {\n          callback(null, response.href, bounds);\n        }\n      }, this));\n    } else {\n      params.f = 'image';\n      callback(null, this.options.url + 'export' + L.Util.getParamString(params), bounds);\n    }\n  },\n\n  /**\n   * Smooth redraw, see\n   * @see https://github.com/w8r/leaflet-wms-bgbuffer\n   * @return {EsriLeaflet.Layers.TiledDynamicMapLayer}\n   */\n  _redraw: function() {\n    if (this._map) {\n      if (this.options.redrawBuffer) {\n        var front = this._tileContainer;\n        this._clearBgBuffer();\n        this._tileContainer = this._bgBuffer;\n        this._bgBuffer = front;\n\n        this._tiles = {};\n        this._tilesToLoad = 0;\n        this._tilesTotal = 0;\n      } else {\n        L.TileLayer.prototype._reset.call(this, {\n          hard: true\n        });\n      }\n    }\n  },\n\n  /**\n   * Override for old IE, just to have bg buffer for tiles\n   */\n  _initContainer: function() {\n    this._animated = this._animated || this.options.redrawBuffer;\n    L.TileLayer.prototype._initContainer.call(this);\n  },\n\n  /**\n   * Bounds or params changed\n   */\n  _update: function() {\n    if (this._map && this._map._animatingZoom) {\n      return;\n    }\n    L.TileLayer.prototype._update.call(this);\n  }\n\n});\n\n(function(methods) {\n  for (var i = 0, len = methods.length; i < len; i++) {\n    EsriLeaflet.Layers.TiledDynamicMapLayer.prototype[methods[i]] =\n      EsriLeaflet.Layers.DynamicMapLayer.prototype[methods[i]];\n  }\n})([\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.getLayers as getLayers */\n  'getLayers',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.getLayerDefs as getLayerDefs */\n  'getLayerDefs',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.getTimeOptions as getTimeOptions */\n  'getTimeOptions',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.metadata as metadata */\n  'metadata',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.query as query */\n  'query',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.identify as identify */\n  'identify',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype.find as find */\n  'find',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype._getPopupData as _getPopupData */\n  '_getPopupData',\n  /** @borrows L.esri.Layers.DynamicMapLayer.prototype._propagateEvent as _propagateEvent */\n  '_propagateEvent'\n]);\n\n// factory\nEsriLeaflet.Layers.tiledDynamicMapLayer =\n  EsriLeaflet.tiledDynamicMapLayer = function(url, options) {\n    return new EsriLeaflet.Layers.TiledDynamicMapLayer(url, options);\n  };\n"]}